# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    branches: [ "master" ]

env:
  APP_NAME: go-cloudrun-hello
  GO_VERSION: "1.22"

permissions:
  id-token: write
  contents: read  # üî¥ REQUIRED for WIF

jobs:
  # ---------------------------
  # 1Ô∏è‚É£ CODE BUILD JOB
  # ---------------------------
  code-build:
    name: Go Code Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Go Vet
        run: go vet ./...

      - name: Go Build
        run: go build -v ./...

      # Optional: run tests
      - name: Go Test
        run: go test ./...

  # ---------------------------
  # 2Ô∏è‚É£ DOCKER IMAGE BUILD JOB
  # ---------------------------
  docker-build:
    name: Docker Image Build
    runs-on: ubuntu-latest
    needs: code-build   # üëà runs only if code-build succeeds

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.APP_NAME }}:${{ github.sha }} \
            -t ${{ env.APP_NAME }}:latest \
            .

      # Optional: verify image
      - name: List Docker Images
        run: docker images

  auth-test:
    name: GCP auth test
    runs-on: ubuntu-latest
    needs: docker-build   # üëà runs only if docker-build succeeds
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        
      - name: Authenticate to GCP using WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA }}

      - name: Verify authentication
        run: |
          gcloud auth list


  artifact-push-deploy:
    name: artifact-registry-repo-push
    runs-on: ubuntu-latest
    needs: auth-test   # üëà runs only if docker-build succeeds
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to GCP (WIF)
      uses: google-github-actions/auth@v2
      with:
           workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
           service_account: ${{ secrets.GCP_SA }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.AR_REPO }}:${{ github.sha }} .

    - name: Push Docker image
      run: |
        docker push ${{ secrets.AR_REPO }}:${{ github.sha }}

    - name: Set GCP project
      run: |
        gcloud config set project fifth-subject-447111-f6

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy test-api \
          --image ${{ secrets.AR_REPO }}:${{ github.sha }} \
          --region asia-south1 \
          --platform managed \
          --allow-unauthenticated
