name: DEV

on:
  push:
    branches-ignore:
      - main
      - master
    tags-ignore:
      - "*"

permissions:
  id-token: write
  contents: read

env:
  APP_NAME: go-cloudrun-hello
  GO_VERSION: "1.22"


jobs:
  # ---------------------------
  # 1Ô∏è‚É£ CODE BUILD JOB
  # ---------------------------
  # code-build:
  #   name: Go Code Build
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout source
  #       uses: actions/checkout@v4

  #     - name: Setup Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: ${{ env.GO_VERSION }}

  #     - name: Download dependencies
  #       run: go mod download

  #     - name: Go Vet
  #       run: go vet ./...

  #     - name: Go Build
  #       run: go build -v ./...

  #     # Optional: run tests
  #     - name: Go Test
  #       run: go test ./...

  # ---------------------------
  # 2Ô∏è‚É£ DOCKER IMAGE BUILD JOB
  # ---------------------------
  # docker-build:
  #   name: Docker Image Build
  #   runs-on: ubuntu-latest
  #   needs: code-build   # üëà runs only if code-build succeeds

  #   steps:
  #     - name: Checkout source
  #       uses: actions/checkout@v4

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Build Docker Image
  #       run: |
  #         docker build \
  #           -t ${{ env.APP_NAME }}:${{ github.sha }} \
  #           -t ${{ env.APP_NAME }}:latest \
  #           .

  #     # Optional: verify image
  #     - name: List Docker Images
  #       run: docker images

  # auth-test:
  #   name: GCP auth test
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout source
  #       uses: actions/checkout@v4
        
  #     - name: Authenticate to GCP using WIF
  #       uses: google-github-actions/auth@v2
  #       with:
  #         workload_identity_provider: projects/169594489917/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider
  #         service_account: github-actions-sa@fifth-subject-447111-f6.iam.gserviceaccount.com

  #     - name: Verify authentication
  #       run: |
  #         gcloud auth list


  docker-push:
    name: artifact-registry-repo-push
    runs-on: ubuntu-latest
    needs: code-build   # üëà runs only if code-build succeeds
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to GCP (WIF)
      uses: google-github-actions/auth@v2
      with:
          workload_identity_provider: projects/169594489917/locations/global/workloadIdentityPools/github-actions-pool/providers/github
          service_account: sa-dev-deployer@fifth-subject-447111-f6.iam.gserviceaccount.com

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet

    - name: Build Docker image
      run: |
        docker build -t asia-south1-docker.pkg.dev/fifth-subject-447111-f6/dev-api-repo/${{ github.actor }}-api:${{ github.sha }} .

    - name: Push Docker image
      run: |
        docker push asia-south1-docker.pkg.dev/fifth-subject-447111-f6/dev-api-repo/${{ github.actor }}-api:${{ github.sha }}

    - name: Set GCP project
      run: |
        gcloud config set project fifth-subject-447111-f6

    # - name: Deploy to Cloud Run
    #   run: |
    #     gcloud run deploy test-api \
    #       --image asia-south1-docker.pkg.dev/fifth-subject-447111-f6/dev-api-repo/${{ github.actor }}-api:${{ github.sha }} \
    #       --region asia-south1 \
    #       --platform managed \
    #       --allow-unauthenticated      
